    <input hidden id="nameStructure" value="<?= $substance->identifier ?>">
    <textarea hidden id="2dInput" class="textin" onload="update()"><?= $substance->SMILES ?>;<?= $substance->name ?></textarea>
    <input hidden id="idSubstance" value="<?= $substance->id ?>">
    <div class="content">
        <div>
            <p class="compoundTitle"><?= $substance->name ?></p>
            <?php if (session::is_admin()) : ?>
                <p style="text-align: right; font-size: 20px;"><a href="/edit/Compound/<?= $substance->id ?>/<?= $substance->name ?>"><span class="glyphicon glyphicon-edit"></span> Edit</a></p>
            <?php endif ?>
        </div>

        <button class="accordion"><i class="fa fa-list-alt" style="font-size:24px;"></i> General info, 2D/3D Structure</button>
        <div class="panelDetail">
            <div class="flex-row space-around">
                <div class="flex-column" style="width: 47%">
                    <div class="general-info" >
                        <div class="heading">
                            <b>2D Structure</b>
                            <span class="glyphicon glyphicon-question-sign popup-hover">
                                <div>
                                    <label>Generated by CDK Depict.</label>
                                </div>
                            </span>
                        </div>
                        <div class="structure">
                            <div id="2dStructure" class="structure2D"></div>
                            <div id="loader"></div>
                        </div>
                    </div>
                    <div class="general-info" style="height: 450px; overflow:unset;">
                        <div class="flex-row space-between">
                            <div class="heading">
                                <b>3D Structure</b>
                                <span class="glyphicon glyphicon-question-sign popup-hover">
                                    <div>
                                        <label>Visualised by LiteMol software.</label>
                                    </div>
                                </span>
                            </div>
                            <div class="structure-source">
                                <div style="margin-right: 5px;">
                                    Source:
                                </div>
                                <div>
                                    <select id="3D_structure_select">
                                        <?php if(count($structures_3d)) : ?>
                                        <?php foreach($structures_3d as $server_id => $structure) : ?>
                                        <option value="<?= $structure['id'] ?>"><?= Validator_identifiers::get_enum_server($server_id) ?></option>
                                        <?php endforeach ?>
                                        <?php else : ?>
                                        <option>N/A</option>
                                        <?php endif ?>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="structure">
                            <div id="litemol" class="structure3D"></div>
                            <script>
                                var structures = JSON.parse('<?= json_encode($structures_3d) ?>');

                                var plugin = LiteMol.Plugin.create({ 
                                    target: '#litemol', 
                                    viewportBackground: '#fff',
                                    layoutState: {
                                        hideControls: true,
                                    } 
                                });

                                $('#3D_structure_select').change(function()
                                {
                                    var id = $('#3D_structure_select').val();
                                    plugin.clear();
                                    plugin.loadMolecule({
                                        id: '<?= $substance->identifier ?>',
                                        url: '<?= Url::base() . 'file/show/' ?>' + id,
                                        format: 'sdf' // default
                                    });
                                });

                                $('#3D_structure_select').trigger('change');
                            </script>
                        </div>
                    </div>
                </div>
                <div class="flex-column" style="width: 47%">
                    <div class="general-info">
                        <table class="table table-hover" style="font-size: 15px;">
                            <thead>
                                <td>
                                    <b style="color: #4a82da">General</b>
                                </td>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <b>Identifier</b></td>
                                    <td><?= $substance->identifier ?>
                                </tr>
                                <tr>
                                    <td><b>SMILES</b></td>
                                    <td>
                                        <?php if (!$identifiers[Validator_identifiers::ID_SMILES] || !$identifiers[Validator_identifiers::ID_SMILES]->value) : ?>
                                                N/A 
                                        <?php else : ?>
                                            <?= $identifiers[Validator_identifiers::ID_SMILES]->value ?>
                                            <?php if($identifiers[Validator_identifiers::ID_SMILES]->state !== Validator_identifiers::STATE_VALIDATED) : ?>
                                                <span class="glyphicon glyphicon-question-sign popup-hover">
                                                    <div>
                                                        <p>Not validated.</p> <br>
                                                        <label><?= $identifiers[Validator_identifiers::ID_SMILES]->text_source ?></label>
                                                    </div>
                                                </span>
                                            <?php elseif($identifiers[Validator_identifiers::ID_SMILES]->text_source) : ?>
                                                <span class="glyphicon glyphicon-ok-circle popup-hover" style="color: green;">
                                                    <div>
                                                    <label><?= $identifiers[Validator_identifiers::ID_SMILES]->text_source ?></label>
                                                    </div>
                                                </span>
                                            <?php endif ?>
                                        <?php endif ?>
                                    </td>
                                </tr>
                                <tr>
                                    <td><b>InChIKey</b></td>
                                    <td>
                                        <?php if (!$identifiers[Validator_identifiers::ID_INCHIKEY] || !$identifiers[Validator_identifiers::ID_INCHIKEY]->value) : ?>
                                                N/A 
                                        <?php else : ?>
                                            <?= $identifiers[Validator_identifiers::ID_INCHIKEY]->value ?>
                                            <?php if($identifiers[Validator_identifiers::ID_INCHIKEY]->state !== Validator_identifiers::STATE_VALIDATED) : ?>
                                                <span class="glyphicon glyphicon-question-sign popup-hover">
                                                    <div>
                                                        <p>Not validated.</p> <br>
                                                        <label><?= $identifiers[Validator_identifiers::ID_INCHIKEY]->text_source ?></label>
                                                    </div>
                                                </span>
                                            <?php elseif($identifiers[Validator_identifiers::ID_INCHIKEY]->text_source) : ?>
                                                <span class="glyphicon glyphicon-ok-circle popup-hover" style="color: green;">
                                                    <div>
                                                    <label><?= $identifiers[Validator_identifiers::ID_INCHIKEY]->text_source ?></label>
                                                    </div>
                                                </span>
                                            <?php endif ?>
                                        <?php endif ?>
                                    </td>
                                </tr>
                                <tr>
                                    <td><b>MW [Da]</b></td>
                                    <td>
                                    <?php if ($substance->MW == 0) : ?>
                                            N/A 
                                        <?php else : ?>
                                            <?= $substance->MW ?> <span class="glyphicon glyphicon-ok-circle popup-hover" style="color: green;">
                                                <div>
                                                    <p>Automatically obtained from <?= Validator_identifiers::get_enum_server(Validator_identifiers::SERVER_RDKIT) ?>.</p>
                                                </div>
                                            </span>
                                        <?php endif ?>
                                    </td>
                                </tr>
                                <tr>
                                    <td><b>LogP</b></td>
                                    <td>
                                        <?php if ($substance->LogP == 0) : ?>
                                            N/A 
                                        <?php else : ?>
                                            <?= $substance->LogP ?> <span class="glyphicon glyphicon-ok-circle popup-hover" style="color: green;">
                                                <div>
                                                    <p>Automatically obtained from <?= Validator_identifiers::get_enum_server(Validator_identifiers::SERVER_RDKIT) ?>.</p>
                                                </div>
                                            </span>
                                        <?php endif ?>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="general-info">
                        <table class="table table-hover">
                            <thead>
                                <td>
                                    <b style="color: #4a82da">Links</b>
                                </td>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <p><b>PubChem</b></p>
                                    </td>
                                    <td>
                                        <?php if (!$identifiers[Validator_identifiers::ID_PUBCHEM] || !$identifiers[Validator_identifiers::ID_PUBCHEM]->value) : ?>
                                                N/A 
                                        <?php else : ?>
                                            <a href="https://pubchem.ncbi.nlm.nih.gov/compound/<?=  $identifiers[Validator_identifiers::ID_PUBCHEM]->value ?>" target="_blank"><?=  $identifiers[Validator_identifiers::ID_PUBCHEM]->value ?></a>
                                            <?php if($identifiers[Validator_identifiers::ID_PUBCHEM]->state !== Validator_identifiers::STATE_VALIDATED) : ?>
                                                <span class="glyphicon glyphicon-question-sign popup-hover">
                                                    <div>
                                                        <p>Not validated.</p> <br>
                                                        <label><?= $identifiers[Validator_identifiers::ID_PUBCHEM]->text_source ?></label>
                                                    </div>
                                                </span>
                                            <?php elseif($identifiers[Validator_identifiers::ID_PUBCHEM]->text_source) : ?>
                                                <span class="glyphicon glyphicon-ok-circle popup-hover" style="color: green;">
                                                    <div>
                                                    <label><?= $identifiers[Validator_identifiers::ID_PUBCHEM]->text_source ?></label>
                                                    </div>
                                                </span>
                                            <?php endif ?>
                                        <?php endif ?>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <p><b>DrugBank</b></p>
                                    </td>
                                    <td>
                                        <?php if (!$identifiers[Validator_identifiers::ID_DRUGBANK] || !$identifiers[Validator_identifiers::ID_DRUGBANK]->value) : ?>
                                                N/A 
                                        <?php else : ?>
                                            <a href="https://www.drugbank.ca/drugs/<?=  $identifiers[Validator_identifiers::ID_DRUGBANK]->value ?>" target="_blank"><?=  $identifiers[Validator_identifiers::ID_DRUGBANK]->value ?></a>
                                            <?php if($identifiers[Validator_identifiers::ID_DRUGBANK]->state !== Validator_identifiers::STATE_VALIDATED) : ?>
                                                <span class="glyphicon glyphicon-question-sign popup-hover">
                                                    <div>
                                                        <p>Not validated.</p> <br>
                                                        <label><?= $identifiers[Validator_identifiers::ID_DRUGBANK]->text_source ?></label>
                                                    </div>
                                                </span>
                                            <?php elseif($identifiers[Validator_identifiers::ID_DRUGBANK]->text_source) : ?>
                                                <span class="glyphicon glyphicon-ok-circle popup-hover" style="color: green;">
                                                    <div>
                                                    <label><?= $identifiers[Validator_identifiers::ID_DRUGBANK]->text_source ?></label>
                                                    </div>
                                                </span>
                                            <?php endif ?>
                                        <?php endif ?>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <p><b>ChEBI</b></p>
                                    </td>
                                    <td>
                                        <?php if (!$identifiers[Validator_identifiers::ID_CHEBI] || !$identifiers[Validator_identifiers::ID_CHEBI]->value) : ?>
                                                N/A 
                                        <?php else : ?>
                                            <a href="http://www.ebi.ac.uk/chebi/searchId.do?chebiId=CHEBI:<?=  $identifiers[Validator_identifiers::ID_CHEBI]->value ?>" target="_blank"><?=  $identifiers[Validator_identifiers::ID_CHEBI]->value ?></a>
                                            <?php if($identifiers[Validator_identifiers::ID_CHEBI]->state !== Validator_identifiers::STATE_VALIDATED) : ?>
                                                <span class="glyphicon glyphicon-question-sign popup-hover">
                                                    <div>
                                                        <p>Not validated.</p> <br>
                                                        <label><?= $identifiers[Validator_identifiers::ID_CHEBI]->text_source ?></label>
                                                    </div>
                                                </span>
                                            <?php elseif($identifiers[Validator_identifiers::ID_CHEBI]->text_source) : ?>
                                                <span class="glyphicon glyphicon-ok-circle popup-hover" style="color: green;">
                                                    <div>
                                                    <label><?= $identifiers[Validator_identifiers::ID_CHEBI]->text_source ?></label>
                                                    </div>
                                                </span>
                                            <?php endif ?>
                                        <?php endif ?>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <p><b>PDB</b></p>
                                    </td>
                                    <td>
                                        <?php if (!$identifiers[Validator_identifiers::ID_PDB] || !$identifiers[Validator_identifiers::ID_PDB]->value) : ?>
                                                N/A 
                                        <?php else : ?>
                                            <a href="https://www.rcsb.org/ligand/<?=  $identifiers[Validator_identifiers::ID_PDB]->value ?>" target="_blank"><?=  $identifiers[Validator_identifiers::ID_PDB]->value ?></a>
                                            <?php if($identifiers[Validator_identifiers::ID_PDB]->state !== Validator_identifiers::STATE_VALIDATED) : ?>
                                                <span class="glyphicon glyphicon-question-sign popup-hover">
                                                    <div>
                                                        <p>Not validated.</p> <br>
                                                        <label><?= $identifiers[Validator_identifiers::ID_PDB]->text_source ?></label>
                                                    </div>
                                                </span>
                                            <?php elseif($identifiers[Validator_identifiers::ID_PDB]->text_source) : ?>
                                                <span class="glyphicon glyphicon-ok-circle popup-hover" style="color: green;">
                                                    <div>
                                                    <label><?= $identifiers[Validator_identifiers::ID_PDB]->text_source ?></label>
                                                    </div>
                                                </span>
                                            <?php endif ?>
                                        <?php endif ?>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <p><b>ChEMBL</b></p>
                                    </td>
                                    <td>
                                        <?php if (!$identifiers[Validator_identifiers::ID_CHEMBL] || !$identifiers[Validator_identifiers::ID_CHEMBL]->value) : ?>
                                                N/A 
                                        <?php else : ?>
                                            <a href="https://www.ebi.ac.uk/chembl/compound/inspect/<?=  $identifiers[Validator_identifiers::ID_CHEMBL]->value ?>" target="_blank"><?=  $identifiers[Validator_identifiers::ID_CHEMBL]->value ?></a>
                                            <?php if($identifiers[Validator_identifiers::ID_CHEMBL]->state !== Validator_identifiers::STATE_VALIDATED) : ?>
                                                <span class="glyphicon glyphicon-question-sign popup-hover">
                                                    <div>
                                                        <p>Not validated.</p> <br>
                                                        <label><?= $identifiers[Validator_identifiers::ID_CHEMBL]->text_source ?></label>
                                                    </div>
                                                </span>
                                            <?php elseif($identifiers[Validator_identifiers::ID_CHEMBL]->text_source) : ?>
                                                <span class="glyphicon glyphicon-ok-circle popup-hover" style="color: green;">
                                                    <div>
                                                    <label><?= $identifiers[Validator_identifiers::ID_CHEMBL]->text_source ?></label>
                                                    </div>
                                                </span>
                                            <?php endif ?>
                                        <?php endif ?>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="flex-column general-info" style="width: 100%">
                <div class="heading">
                    <div><b>Similar entries</b></div>
                </div>
                <div class="flex-row" style="width: 100%; overflow-x: auto; padding-bottom: 40px;">
                    <?php foreach($similar_entries as $record) : ?>
                        <?= Render_similar_entry_item::print($record, $stats_interactions) ?>
                    <?php endforeach ?>
                    <?php if($total_similar_entries) : ?>
                        <?= Render_similar_entry_item::print_next($total_similar_entries, count($similar_entries)) ?>
                    <?php endif ?> 
                </div>
            </div>
        </div>
        <button class="accordion"><i class="glyphicon glyphicon-stats" style="font-size:24px;"></i> Passive interactions</button>
        <div class="panelDetail" id="accordionInteraction" style="position: relative;">
            <div id="interaction_loader"></div>
            <div class="no-data" id="no-data-panel">
                <p><i class="fa fa-line-chart"></i> No data</p>
            </div>

            <?php $colors = [
                ["#67b7dc"],
                ["#6771dc"],
                ["#a367dc"]
            ]
            ?>
            
            <h4 style="text-align: center; font-weight: bold;"><?= Html::anchor("browse/methods", "Methods", true) ?></h4>
            <div class="flex-column">
                <?php foreach($methods_cat as $key => $cat_1): ?>
                <?php $color = $colors[$key % count($colors)][0]; ?>
                <div class="detail-method-category" style="border-color: <?= $color ?>; background: <?= $color ?>; background: linear-gradient(180deg, <?= $color ?> 25px, #ffffff 40px);">
                    <div><?= $cat_1['name'] ?></div>
                    <div class="category-options">
                        <?php foreach($cat_1['children'] as $index => $cat_2) :?>
                            <div class="detail-method-category-inner">
                                <div style="color: <?= $color ?>; font-weight: bold;"><?= $cat_2['name'] ?></div>
                                <div class="category-items">
                                    <?php foreach($cat_2['children'] as $item) : ?>
                                    <button class="btn-methods" id="btn_meth_<?=$item['id_element']?>" onclick="showRows(this, '<?= $substance->id ?>')"><?= $item['name'] ?></button>
                                    <?php endforeach ?>
                                </div>
                            </div>
                        <?php endforeach ?>
                    </div>
                </div>
                <?php endforeach ?>
            </div>

            <div id="interaction-panel">
                <div class="table-detail " style="overflow-x: auto;">
                    <div class="detail-content" id="detailTab">
                        <div hidden></div>
                    </div>
                </div>
                <button type="button" class="btn pull-right btn-warning" onclick="export_detail_data('<?= $substance->uploadName ?>')">Export data [.csv]</button>
                <button type="button" class="btn pull-right btn-info" onclick="add_to_comparator('<?= $substance->id ?>', '<?= $substance->name ?>')" style="margin-right: 10px;">Add to comparator</button>
            </div>
        </div>

              <button class="accordion"><i class="glyphicon glyphicon-transfer" style="font-size: 24px;"></i>  Transporters</button>
       <div class="panelDetail" id="accordionInteraction">
           <div class="no-data" id="no-data-panel">
                   <p><i class="fa fa-line-chart"></i>   No data</p>
           </div>
           
           <div id="transporter-panel">
               <div class="table-detail " style="overflow-x: auto;">
                   <div class="detail-content" id="transporterTab">
                    <?= $nonsec_transporters_html ?>
                   </div>
               </div>
           </div>
       </div>

        <button class="accordion"><i class="fa fa-line-chart" style="font-size:24px;"></i> Free energy graph </button>
        <div class="panelDetail">
            <div class="no-data" id="no-data-panel2">
                <p><i class="fa fa-line-chart"></i> No data</p>
            </div>
            <div class="flex-row free-energy-container">
                <div id="chart-panel">
                    <table class="chart-adv">

                        <thead>
                            <tr>
                                <td>
                                    Methods
                                </td>
                                <td>
                                    Membranes
                                </td>
                            </tr>
                        </thead>

                        <tbody>
                            <?php foreach ($energy as $data) : ?>
                                <tr>
                                    <td class="method">
                                        <?= $data[0]->method_name ?>
                                    </td>
                                    <td>
                                        <div class="tabBlock">
                                            <?php foreach ($data as $record) : ?>

                                                <div class="membraneTab not-active">
                                                    <input hidden value="<?= $record->id_energy ?>">
                                                    <?= $record->membrane_name ?>
                                                </div>

                                            <?php endforeach ?>
                                        </div>
                                    </td>
                                </tr>
                            <?php endforeach ?>
                        </tbody>
                    </table>
                    <button type="button" id="export_chart_data" style="margin-top: 25px;" class="btn btn-warning pull-right">Export displayed data [.csv]</button>
                </div>
                <div style="min-height: 800px;">
                    <canvas id="myChart" width="100%" height="100%"></canvas>
                </div>
            </div>

        </div>
    </div>

    <script src="js/detailStyle.js?ver=<?= JS_VERSION ?>">
    </script>

    <script src="js/lineChart.js?ver=<?= JS_VERSION ?>">
    </script>

    <script>
        var id_substance = '<?= $substance->id ?>';
        var total_similar = parseInt('<?= $total_similar_entries ?>');

        function load_3d_chart()
        {
            let ids = [];

            $('.membraneTab').each((i,e) => {
                if($(e).hasClass('not-active'))
                {
                    return;
                }

                $(e).find('input').each((k,p) => {
                    var id = $(p).val();

                    if(!id)
                    {
                        return;
                    }

                    ids.push(id);
                });
            });

            var data = ajax_request('energy/detail', {'id': ids});
            
            if(!data)
            {
                add_message('Cannot obtain data from remote server.', 'danger');
                return;
            }

            loadLineChart(data);
        }

        let similar_entries_loading = false;

        function init_callbacks()
        {
            $('.membraneTab').click(function()
            {
                if($(this).hasClass('not-active'))
                {
                    $(this).removeClass('not-active');
                    $(this).addClass('active');
                }
                else
                {
                    $(this).removeClass('active');
                    $(this).addClass('not-active');
                }

                load_3d_chart();
            });

            $('.similar-entry-get-next').click(async function()
            {
                let parent = $(this).parent();
                let ch = $(parent).children();
                let visible = ch.length-1;

                if(similar_entries_loading)
                {
                    return;
                }

                similar_entries_loading = true;

                $(this).find('.ctnt').each((i, e) =>
                {
                    $(e).html('Loading...');
                });

                let data = ajax_request('compounds/similar/html', {id: id_substance, offset: visible, limit: '<?= MolController::VISIBLE_BY_PAGE ?>'});

                if(!data)
                {
                    $(this).find('.ctnt').each((i, e) =>
                    {
                        $(e).html('Error occured during loading data.');
                    });
                    similar_entries_loading = false;
                    return;
                }

                // Delete old "get-next"
                $('.similar-entry-get-next').each((i,e) => {
                    $(e).remove();
                });

                // Add new items
                for(var i = 0; i < data.length; i++)
                {
                    $(parent).append($.parseHTML(data[i]));
                }

                visible = visible + data.length;

                if(visible >= total_similar)
                {
                    return;
                }

                // Add button "get-next"
                let next = ajax_request('compounds/similar/next/html', {total: total_similar, visible: visible});

                if(!next)
                {
                    return;
                }

                let el = $.parseHTML(next);

                $(parent).append(el);

                similar_entries_loading = false;

                init_callbacks();
            });
        }

        window.onload = function ()
        {
            update();
            init_callbacks();
        };

        
    </script>